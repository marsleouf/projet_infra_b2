# First try

```sh
PS C:\Users\marsl> ping quentinguiheneuc.fr

Envoi d’une requête 'ping' sur quentinguiheneuc.fr [193.250.53.76] avec 32 octets de données :
Délai d’attente de la demande dépassé.
Réponse de 193.250.53.76 : octets=32 temps=125 ms TTL=60
Réponse de 193.250.53.76 : octets=32 temps=61 ms TTL=60
Réponse de 193.250.53.76 : octets=32 temps=130 ms TTL=60

Statistiques Ping pour 193.250.53.76:
    Paquets : envoyés = 4, reçus = 3, perdus = 1 (perte 25%),
Durée approximative des boucles en millisecondes :
    Minimum = 61ms, Maximum = 130ms, Moyenne = 105ms
```

```bash
pi@raspberrypi:/etc/nginx/conf.d $ cat new_sites.conf
server {
        listen 80;
        server_name quentinguiheneuc.fr www.quentinguiheneuc.fr;

        location / {
                proxy_set_header X-Real-IP $remote_addr;
                proxy_pass http://localhost:8080;
        }
}

pi@raspberrypi:/etc/nginx $ cat proxy_params
proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;



pi@raspberrypi:/etc/nginx/sites-available $ cat default
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
        #location ~ \.php$ {
        #       include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
        #       fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}
```

try by creating a proxy.conf in sites-available/

```sh
sudo apt-get install nginx

# disbale virtual host

sudo unlink /etc/nginx/sutes-enabled/default

# go in etc/nginx/sites-available/

sudo nano reverse-proxy.conf

# in reverse-proxy.conf

server {
    listen 80;
    server_name www.example.com example.com;

    location /app {
       proxy_pass http://127.0.0.1:8080;
    }
}

# then 

sudo ln -s /etc/nginx/sites-available/reverse-proxy.conf /etc/nginx/sites-enabled/reverse-proxy.conf

# then

service nginx configtest

nginx restart

nnginx -t

# and it should run properly but no 
```

so tried another config

```sh
server {
    listen 80;
    location / {
        proxy_pass http://192.x.x.2;
    }
}
# where 192.x.x.2 is the website ip adress
# still nothing
```

# Second try

We used [that one link](https://www.digitalocean.com/community/tools/nginx?global.app.lang=fr) for this part.

Once the different empty block completed, the website generate an archive.

Place it in your proxy server and then unpack it with:
```sh
sudo tar -xzvf nginxconfig.io-quentinguiheneuc.fr.tar.gz
```

You should have this:
```sh
pi@raspberrypi:/etc/nginx $ ls
conf.d          koi-utf     modules-available  nginxconfig.io                             scgi_params      snippets      win-utf
fastcgi.conf    koi-win     modules-enabled    nginxconfig.io-quentinguiheneuc.fr.tar.gz  sites-available  ssl
fastcgi_params  mime.types  nginx.conf         proxy_params                               sites-enabled    uwsgi_params
```

Let's have a look on the nginx configuration:
```sh
[nginx.conf]

# Generated by nginxconfig.io
# https://www.digitalocean.com/community/tools/nginx?domains.0.server.domain=quentinguiheneuc.fr&domains.0.server.path=%2Fvar%2Fwww%2Fhtml%2F&domains.0.server.listenIpv4=192.168.1.39&domains.0.https.certType=custom&domains.0.https.sslCertificate=%2Fetc%2Fnginx%2Fssl%2Fquentinguihenuc.fr.crt&domains.0.https.sslCertificateKey=%2Fetc%2Fnginx%2Fssl%2Fquentinguihenuc.fr.key&domains.0.logging.accessLog=true&domains.0.logging.errorLog=true&global.logging.logNotFound=true&global.app.lang=fr

user                 www-data;
pid                  /run/nginx.pid;
worker_processes     auto;
worker_rlimit_nofile 65535;

events {
    multi_accept       on;
    worker_connections 65535;
}

# Load modules
include /etc/nginx/modules-enabled/*;

http {
    charset                utf-8;
    sendfile               on;
    tcp_nopush             on;
    tcp_nodelay            on;
    server_tokens          off;
    types_hash_max_size    2048;
    types_hash_bucket_size 64;
    client_max_body_size   16M;

    # MIME
    include                mime.types;
    default_type           application/octet-stream;

    # Logging
    access_log             /var/log/nginx/access.log;
    error_log              /var/log/nginx/error.log warn;

    # SSL
    ssl_session_timeout    1d;
    ssl_session_cache      shared:SSL:10m;
    ssl_session_tickets    off;

    # Diffie-Hellman parameter for DHE ciphersuites
    ssl_dhparam            /etc/nginx/dhparam.pem;

    # Mozilla Intermediate configuration
    ssl_protocols          TLSv1.2 TLSv1.3;
    ssl_ciphers            ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

    # OCSP Stapling
    ssl_stapling           on;
    ssl_stapling_verify    on;
    resolver               1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4 208.67.222.222 208.67.220.220 valid=60s;
    resolver_timeout       2s;

    # Load configs
    include                /etc/nginx/conf.d/*.conf;
    include                /etc/nginx/sites-enabled/*;
```

In the directory `nginxconfig.io`, we've got three files, `general.conf`,`php_fastcgi.conf`,`security.conf`.

> ```sh
> [general.conf]
> 
> # favicon.ico
> location = /favicon.ico {
>     log_not_found off;
>     access_log    off;
> }
> 
> # robots.txt
> location = /robots.txt {
>     log_not_found off;
>     access_log    off;
> }
> 
> # assets, media
> location ~* \.(?:css(\.map)?|js(\.map)?|jpe?g|png|gif|ico|cur|heic|webp|> tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv)$ {
>     expires    7d;
>     access_log off;
> }
> 
> # svg, fonts
> location ~* \.(?:svgz?|ttf|ttc|otf|eot|woff2?)$ {
>     add_header Access-Control-Allow-Origin "*";
>     expires    7d;
>     access_log off;
> }
> 
> # gzip
> gzip            on;
> gzip_vary       on;
> gzip_proxied    any;
> gzip_comp_level 6;
> gzip_types      text/plain text/css text/xml application/json application/> javascript application/rss+xml application/atom+xml image/svg+xml;
> ```
> 
> ```sh
> [php_fastcgi.conf]
> 
> # 404
> try_files                     $fastcgi_script_name =404;
> 
> # default fastcgi_params
> include                       fastcgi_params;
> 
> # fastcgi settings
> fastcgi_index                 index.php;
> fastcgi_buffers               8 16k;
> fastcgi_buffer_size           32k;
> 
> # fastcgi params
> fastcgi_param DOCUMENT_ROOT   $realpath_root;
> fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
> fastcgi_param PHP_ADMIN_VALUE "open_basedir=$base/:/usr/lib/php/:/tmp/";
> ```
> 
> ```sh
> [security.conf]
> 
> # security headers
> add_header X-Frame-Options           "SAMEORIGIN" always;
> add_header X-XSS-Protection          "1; mode=block" always;
> add_header X-Content-Type-Options    "nosniff" always;
> add_header Referrer-Policy           "no-referrer-when-downgrade" always;
> add_header Content-Security-Policy   "default-src 'self' http: https: > data: blob: 'unsafe-inline'" always;
> add_header Strict-Transport-Security "max-age=31536000; > includeSubDomains" always;
> 
> # . files
> location ~ /\.(?!well-known) {
>     deny all;
> }
> ```

In `sites-availables`, we've got the following file:
```sh
[quentinguiheneuc.fr.conf]

server {
    listen              443 ssl http2;
    listen              [::]:443 ssl http2;
    server_name         quentinguiheneuc.fr;
    set                 $base /var/www/html/;
    root                $base/public;

    # SSL
    ssl_certificate     /etc/nginx/ssl/quentinguihenuc.fr.crt;
    ssl_certificate_key /etc/nginx/ssl/quentinguihenuc.fr.key;

    # security
    include             nginxconfig.io/security.conf;

    # logging
    access_log          /var/log/nginx/quentinguiheneuc.fr.access.log;
    error_log           /var/log/nginx/quentinguiheneuc.fr.error.log warn;

    # index.php
    index               index.php;

    # index.php fallback
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # additional config
    include nginxconfig.io/general.conf;

    # handle .php
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        include      nginxconfig.io/php_fastcgi.conf;
    }
}

# subdomains redirect
server {
    listen              443 ssl http2;
    listen              [::]:443 ssl http2;
    server_name         *.quentinguiheneuc.fr;

    # SSL
    ssl_certificate     /etc/nginx/ssl/quentinguihenuc.fr.crt;
    ssl_certificate_key /etc/nginx/ssl/quentinguihenuc.fr.key;
    return              301 https://quentinguiheneuc.fr$request_uri;
}

# HTTP redirect
server {
    listen      80;
    listen      [::]:80;
    server_name .quentinguiheneuc.fr;
    return      301 https://quentinguiheneuc.fr$request_uri;
}
```

While in `sites-enabled` we have aproximatively the same but with major differences:
```sh
[quentinguiheneuc.fr.conf]

server {
    listen              443 ssl http2;
    listen              [::]:443 ssl http2;
    server_name         quentinguiheneuc.fr;
    set                 $base /var/www/html/;
    root                $base/public;

    # SSL
    ssl_certificate     /etc/nginx/ssl/quentinguihenuc.fr.crt;
    ssl_certificate_key /etc/nginx/ssl/quentinguihenuc.fr.key;

    # security
    include             nginxconfig.io/security.conf;

    # logging
    access_log          /var/log/nginx/quentinguiheneuc.fr.access.log;
    error_log           /var/log/nginx/quentinguiheneuc.fr.error.log warn;

    # index.php
    index               index.php;

    # index.php fallback
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # additional config
    include nginxconfig.io/general.conf;

    # handle .php
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php-fpm.sock;
        include      nginxconfig.io/php_fastcgi.conf;
    }
}

# subdomains redirect
server {
    listen              443 ssl http2;
    listen              [::]:443 ssl http2;
    server_name         *.quentinguiheneuc.fr;

    # SSL
    ssl_certificate     /etc/nginx/ssl/quentinguihenuc.fr.crt;
    ssl_certificate_key /etc/nginx/ssl/quentinguihenuc.fr.key;
    return              301 https://quentinguiheneuc.fr$request_uri;
}

# HTTP redirect
server {
    listen      80;
    listen      [::]:80;
    server_name .quentinguiheneuc.fr;
    return      301 https://quentinguiheneuc.fr$request_uri;
}
```

But the most important file is in `conf.d`, which is:

```sh
[new_sites.conf]

server {
        listen 80;
        server_name quentinguiheneuc.fr www.quentinguiheneuc.fr;

        location / {
                proxy_set_header X-Real-IP $remote_addr;
                proxy_pass http://localhost:8080;
        }
}
```
